#!/bin/bash

#Temporarily change $HOME environment variable
export HOME=/root

#Update list of packages
apt update

#Install Xfce (Desktop Environment)
apt install xfce4 xfce4-goodies -y

#Install TightVNC server
apt install tightvncserver -y

#Install additional packages for automation
apt install expect novnc websockify python-numpy -y

#Use expect to enter password for vncserver automatically
prog=/usr/bin/vncpasswd
vncpass="P@ssw0rd"

/usr/bin/expect <<EOF
spawn $prog
expect "Password:"
send "$vncpass\r"
expect "Verify:"
send "$vncpass\r"
expect "Would you like to enter a view-only password (y/n)?"
send "n\r"
expect eof
exit
EOF

#Start vncserver
vncserver

#------------------------------------- Configuring VNC Server ----------------------------------
#Stop vncserver
vncserver -kill :1

#Backup original vnc file
mv ~/.vnc/xstartup ~/.vnc/xstartup.bak

#Create new vnc file
echo "#!/bin/bash
xrdb $HOME/.Xresources
startxfce4 &" > ~/.vnc/xstartup

#Make VNC file executable
chmod +x ~/.vnc/xstartup

#Restart VNC server
vncserver

#----------------------------------- Running VNS as System Service ------------------------------

#Create configuration file
echo "[Unit]
Description=Start TightVNC server at startup
After=syslog.target network.target

[Service]
Type=forking
User=root
WorkingDirectory=/root

PIDFile=/root/.vnc/%H:%i.pid
ExecStartPre=-/usr/bin/vncserver -kill :%i > /dev/null 2>&1
ExecStart=/usr/bin/vncserver :%i
ExecStop=/usr/bin/vncserver -kill :%i

[Install]
WantedBy=multi-user.target" > /etc/systemd/system/vncserver@.service

#Reload daemon and restart vncserver
systemctl daemon-reload
systemctl enable vncserver@1.service
systemctl start vncserver@1